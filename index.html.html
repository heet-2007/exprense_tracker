<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>FinFlow - Expense Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // This enables class-based dark mode
            theme: {
                extend: {
                    // You can add custom dark mode colors here if needed
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* NEW: Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .dark .glass-effect {
            background: rgba(26, 31, 43, 0.85);
        }

        @keyframes slideFadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: slideFadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* NEW: Toast Animations */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        /* --- */

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .anim-fade {
            animation: fadeIn 0.7s ease-out forwards;
            animation-fill-mode: backwards; /* Start hidden */
        }
        .anim-scale {
            animation: scaleIn 0.5s ease-out forwards;
            animation-fill-mode: backwards;
        }
        .anim-slide-fade-up {
            animation: slideFadeInUp 0.6s ease-out forwards;
            animation-fill-mode: backwards;
        }

        .anim-delay-1 { animation-delay: 100ms; }
        .anim-delay-2 { animation-delay: 200ms; }
        .anim-delay-3 { animation-delay: 300ms; }
        .anim-delay-4 { animation-delay: 400ms; }
        .anim-delay-5 { animation-delay: 500ms; }

        /* --- NEW: User Select Disable --- */
        body, p, h1, h2, h3, h4, h5, h6, span, div, a, button, label, i, nav {
            user-select: none;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE */
        }
        input, textarea, [contenteditable="true"] {
            user-select: auto;
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
        }

        /* --- NEW: Password Toggle Style --- */
        /* This CSS correctly positions the icon vertically centered and on the right */
        .password-toggle-icon {
            position: absolute;
            top: 67%;
            right: 0.75rem; /* 12px */
            transform: translateY(-50%);
            cursor: pointer;
            color: #94a3b8; /* slate-400 */
        }
        .dark .password-toggle-icon {
            color: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="text-slate-800 dark:bg-slate-950 dark:text-slate-200">

    <div id="toast-notification" class="hidden fixed top-6 right-6 z-[100] p-4 rounded-xl shadow-2xl max-w-xs w-full transition-all duration-300">
        <div class="flex items-center gap-3">
            <i id="toast-icon" class="fas fa-check-circle text-xl"></i>
            <p id="toast-message" class="font-medium text-sm"></p>
        </div>
    </div>


    <div id="auth-section" class="hidden min-h-screen flex items-center justify-center bg-indigo-50 p-4 dark:bg-slate-900">
        
        <div id="login-form" class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-md transition-all duration-300 animate-fade-in">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 text-indigo-600 mb-4 dark:bg-indigo-900/50 dark:text-indigo-300 anim-scale">
                    <i class="fas fa-wallet text-2xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-white anim-fade anim-delay-1">Welcome!</h2>
                <p class="text-slate-500 mt-2 dark:text-slate-400 anim-fade anim-delay-2">Login to manage your finances</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-4 anim-fade anim-delay-3">
                    <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Email ID</label>
                    <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                </div>
                <div class="mb-6 anim-fade anim-delay-4 relative">
                    <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Password</label>
                    <input type="password" id="login-password" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400 pr-10">
                    <i id="login-eye-icon" class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('login-password', 'login-eye-icon')"></i>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-lg shadow-indigo-200 transition-all transform hover:scale-[1.02] dark:shadow-indigo-900/50 anim-scale anim-delay-5">
                    Log In
                </button>
            </form>
            <p class="text-center mt-6 text-slate-600 dark:text-slate-300 anim-fade anim-delay-5">
                Don't have an account? <a href="#" onclick="toggleAuth('signup')" class="text-indigo-600 font-semibold hover:underline dark:text-indigo-400">Sign Up</a>
            </p>
        </div>

        <div id="signup-form" class="hidden bg-white p-8 rounded-2xl shadow-xl w-full max-w-md transition-all duration-300 dark:bg-slate-800 animate-fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white anim-fade anim-delay-1">Create Account</h2>
                <p class="text-slate-500 mt-1 dark:text-slate-400 anim-fade anim-delay-2">Start tracking your expenses today</p>
            </div>
            <form onsubmit="handleSignup(event)"> 
                
                <input type="file" id="signup-photo" class="hidden" accept="image/*" onchange="previewImage(event, 'signup-preview', 'signup-placeholder')">
                
                <div class="mb-4 flex justify-center anim-scale anim-delay-3">
                    <label for="signup-photo" class="relative w-24 h-24 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:border-indigo-500 transition-colors overflow-hidden dark:bg-slate-700 dark:border-slate-600 dark:hover:border-indigo-500">
                        
                        <img id="signup-preview" class="hidden absolute top-0 left-0 w-full h-full object-cover" alt="Preview">

                        <div id="signup-placeholder" class="text-center text-slate-400 dark:text-slate-500 z-10">
                            <i class="fas fa-camera text-xl mb-1"></i>
                            <span class="text-xs block">Upload</span>
                        </div>
                    </label>
                </div>
                <div class="mb-4 anim-fade anim-delay-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Full Name</label>
                    <input type="text" id="signup-name" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" placeholder="John Doe">
                </div>
                <div class="mb-4 anim-fade anim-delay-5">
                    <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Email ID</label>
                    <input type="email" id="signup-email" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" placeholder="user@example.com">
                </div>
                <div class="mb-6 anim-fade anim-delay-5 relative">
                    <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Password</label>
                    <input type="password" id="signup-password" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400 pr-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <i id="signup-eye-icon" class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('signup-password', 'signup-eye-icon')"></i>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg shadow-lg shadow-indigo-200 transition-all transform hover:scale-[1.02] dark:shadow-indigo-900/50 anim-scale anim-delay-5">
                    Sign Up
                </button>
            </form>
            <p class="text-center mt-6 text-slate-600 dark:text-slate-300 anim-fade anim-delay-5">
                Already have an account? <a href="#" onclick="toggleAuth('login')" class="text-indigo-600 font-semibold hover:underline dark:text-indigo-400">Log In</a>
            </p>
        </div>
    </div>

    <div id="app-section" class="hidden flex h-screen overflow-hidden bg-slate-50 dark:bg-slate-950">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col dark:bg-slate-900">
            
            <!-- MODIFIED: Wrapped header in a link to navigate to dashboard -->
            <a href="#" onclick="navigate('dashboard')" class="flex items-center justify-start p-6 border-b border-slate-100 gap-3 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors cursor-pointer">
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-indigo-600 text-white shadow-lg shadow-indigo-200 dark:shadow-indigo-900/50">
                    <i class="fas fa-wallet"></i>
                </span>
                <h1 class="text-xl font-bold text-indigo-700 dark:text-indigo-400">FinFlow</h1>
            </a>

            <a href="#" onclick="navigate('profile')" id="nav-profile-block" class="nav-item block p-6 border-b border-slate-100 flex items-center gap-4 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                <img id="sidebar-user-photo" src="https://placehold.co/100x100/6366f1/ffffff?text=USER" alt="User" class="w-12 h-12 rounded-full shadow-sm object-cover">
                <div>
                    <h3 class="font-bold text-slate-800 dark:text-slate-100" id="user-name">User Name</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400" id="user-email">user@email.com</p>
                </div>
            </a>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="#" onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-600 font-medium transition-colors dark:bg-indigo-900/50 dark:text-indigo-300">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </a>
                <a href="#" onclick="navigate('income')" id="nav-income" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-100">
                    <i class="fas fa-money-bill-wave w-5"></i> Incomes
                </a>
                <a href="#" onclick="navigate('expenses')" id="nav-expenses" class="nav-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-100">
                    <i class="fas fa-credit-card w-5"></i> Expenses
                </a>
                <a href="#" onclick="navigate('profile')" id="nav-profile" class="nav-item md:hidden flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-100">
                    <i class="fas fa-user-circle w-5"></i> Profile
                </a>
            </nav>

            <div class="p-4 border-t border-slate-100 dark:border-slate-700">
                <button onclick="toggleDarkMode()" id="dark-mode-toggle" class="flex items-center justify-between gap-3 px-4 py-3 w-full rounded-xl text-slate-600 hover:bg-slate-50 transition-colors font-medium dark:text-slate-400 dark:hover:bg-slate-800">
                    <span class="flex items-center gap-3">
                        <i id="moon-icon" class="fas fa-moon w-5"></i>
                        <i id="sun-icon" class="fas fa-sun w-5 hidden"></i> 
                        <span id="theme-text">Dark Mode</span>
                    </span>
                    <span class="text-xs text-slate-400">Toggle</span>
                </button>
            </div>

            <div class="p-4 border-t border-slate-100 dark:border-slate-700">
                <button onclick="logout()" class="flex items-center gap-3 px-4 py-3 w-full rounded-xl text-red-500 hover:bg-red-50 transition-colors font-medium dark:text-red-500 dark:hover:bg-red-900/30">
                    <i class="fas fa-sign-out-alt w-5"></i> Sign Out
                </button>
            </div>
        </aside>

        <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden dark:bg-black/80"></div>

        <main class="flex-1 md:ml-64 h-full overflow-y-auto">
            <header class="bg-white p-4 flex items-center justify-between shadow-sm md:hidden sticky top-0 z-30 dark:bg-slate-900 dark:border-b dark:border-slate-700 dark:shadow-none">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="text-slate-600 p-2 hover:bg-slate-100 rounded-lg dark:text-slate-300 dark:hover:bg-slate-800">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <!-- MODIFIED: Made FinFlow logo clickable -->
                    <a href="#" onclick="navigate('dashboard')">
                        <h1 class="text-lg font-bold text-indigo-700 dark:text-indigo-400">FinFlow</h1>
                    </a>
                </div>
                
                <img id="header-user-photo" src="https://placehold.co/100x100/6366f1/ffffff?text=USER" class="w-8 h-8 rounded-full object-cover">
            </header>

            <div class="p-6 max-w-7xl mx-auto">
                
                <div id="view-dashboard" class="view-section space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 anim-fade">Dashboard</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-scale anim-delay-1">
                            <h3 class="text-slate-500 font-medium text-sm mb-2 dark:text-slate-400">Total Balance</h3>
                            <div class="flex items-baseline gap-2 anim-fade anim-delay-2">
                                <span class="text-3xl font-bold text-slate-800 dark:text-slate-100" id="total-balance">‚Çπ0</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-2 dark:text-slate-500">Available funds</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-scale anim-delay-2">
                            <h3 class="text-slate-500 font-medium text-sm mb-2 dark:text-slate-400">Total Income</h3>
                            <div class="flex items-baseline gap-2 anim-fade anim-delay-3">
                                <span class="text-3xl font-bold text-emerald-500 dark:text-emerald-400" id="total-income">‚Çπ0</span>
                                <i class="fas fa-arrow-up text-emerald-500 dark:text-emerald-400 text-sm"></i>
                            </div>
                            <p class="text-xs text-slate-400 mt-2 dark:text-slate-500">Recorded earnings</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-scale anim-delay-3">
                            <h3 class="text-slate-500 font-medium text-sm mb-2 dark:text-slate-400">Total Expense</h3>
                            <div class="flex items-baseline gap-2 anim-fade anim-delay-4">
                                <span class="text-3xl font-bold text-red-500 dark:text-red-400" id="total-expense">‚Çπ0</span>
                                <i class="fas fa-arrow-down text-red-500 dark:text-red-400 text-sm"></i>
                            </div>
                            <p class="text-xs text-slate-400 mt-2 dark:text-slate-500">Total spending</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-4">
                            <h3 class="font-bold text-slate-800 mb-4 dark:text-slate-100">Financial Overview</h3>
                            <div class="relative h-64 w-full">
                                <canvas id="dashboardLineChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-5">
                            <h3 class="font-bold text-slate-800 mb-4 dark:text-slate-100">Recent History</h3>
                            <div id="recent-transactions-list" class="space-y-3">
                                <p class="text-sm text-slate-400 text-center py-4 dark:text-slate-500">No transactions yet.</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-5">
                            <h3 class="font-bold text-slate-800 mb-4 dark:text-slate-100">Income vs Expense</h3>
                            <div class="h-48 w-full flex justify-center">
                                <canvas id="dashboardDoughnutChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-5">
                            <h3 class="font-bold text-slate-800 mb-4 dark:text-slate-100">Min/Max Stats</h3>
                            <div class="space-y-4">
                                <div class="bg-emerald-50 p-3 rounded-xl flex justify-between items-center dark:bg-emerald-950/50">
                                    <span class="text-emerald-700 font-medium dark:text-emerald-500">Max Income</span>
                                    <span class="text-emerald-700 font-bold dark:text-emerald-400" id="max-income-val">‚Çπ0</span>
                                </div>
                                <div class="bg-red-50 p-3 rounded-xl flex justify-between items-center dark:bg-red-950/50">
                                    <span class="text-red-700 font-medium dark:text-red-500">Max Expense</span>
                                    <span class="text-red-700 font-bold dark:text-red-400" id="max-expense-val">‚Çπ0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-income" class="view-section hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 anim-fade anim-delay-1">Incomes</h2>
                        <button onclick="openModal('income')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow-lg shadow-indigo-200 flex items-center gap-2 transition-all dark:shadow-indigo-900/50 anim-scale anim-delay-2">
                            <i class="fas fa-plus"></i> Add Income
                        </button>
                    </div>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1 anim-fade anim-delay-3">
                            <label for="income-filter" class="text-sm font-medium text-slate-600 dark:text-slate-400">Filter by Category</label>
                            <select id="income-filter" class="mt-1 w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div class="flex-1 anim-fade anim-delay-4">
                            <label for="income-sort" class="text-sm font-medium text-slate-600 dark:text-slate-400">Sort by</label>
                            <select id="income-sort" class="mt-1 w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="date-desc">Date (Newest)</option>
                                <option value="date-asc">Date (Oldest)</option>
                                <option value="amount-desc">Amount (High-Low)</option>
                                <option value="amount-asc">Amount (Low-High)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-4">
                        <h3 class="font-bold text-slate-800 mb-4 dark:text-slate-100">Income Analytics</h3>
                         <div class="h-64 w-full">
                            <canvas id="incomeBarChart"></canvas>
                         </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4 anim-slide-fade-up anim-delay-5" id="income-list">
                    </div>
                </div>

                <div id="view-expenses" class="view-section hidden space-y-6 animate-fade-in">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 anim-fade anim-delay-1">Expenses</h2>
                        <button onclick="openModal('expense')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg shadow-red-200 flex items-center gap-2 transition-all dark:shadow-red-900/50 anim-scale anim-delay-2">
                            <i class="fas fa-plus"></i> Add Expense
                        </button>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1 anim-fade anim-delay-3">
                            <label for="expense-filter" class="text-sm font-medium text-slate-600 dark:text-slate-400">Filter by Category</label>
                            <select id="expense-filter" class="mt-1 w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div class="flex-1 anim-fade anim-delay-4">
                            <label for="expense-sort" class="text-sm font-medium text-slate-600 dark:text-slate-400">Sort by</label>
                            <select id="expense-sort" class="mt-1 w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                <option value="date-desc">Date (Newest)</option>
                                <option value="date-asc">Date (Oldest)</option>
                                <option value="amount-desc">Amount (High-Low)</option>
                                <option value="amount-asc">Amount (Low-High)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-4">
                        <h3 class="font-bold text-slate-800 mb-4 dark:text-slate-100">Expense Analytics</h3>
                        <div class="h-64 w-full">
                           <canvas id="expenseLineChart"></canvas>
                        </div>
                   </div>

                    <div class="grid grid-cols-1 gap-4 anim-slide-fade-up anim-delay-5" id="expense-list">
                    </div>
                </div>

                <div id="view-profile" class="view-section hidden space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 anim-fade anim-delay-1">My Profile</h2>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-2">
                        <h3 class="font-bold text-slate-800 mb-6 dark:text-slate-100 text-lg">Profile Information</h3>
                        <form onsubmit="handleUpdateProfile(event)" class="space-y-4">
                            
                            <input type="file" id="profile-photo" class="hidden" accept="image/*" onchange="previewImage(event, 'profile-preview', 'profile-placeholder')">
                
                            <div class="flex flex-col items-center gap-4 sm:flex-row">
                                <label for="profile-photo" class="relative w-32 h-32 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:border-indigo-500 transition-colors overflow-hidden dark:bg-slate-700 dark:border-slate-600 dark:hover:border-indigo-500">
                                    <img id="profile-preview" class="hidden absolute top-0 left-0 w-full h-full object-cover" alt="Preview">
                                    <div id="profile-placeholder" class="text-center text-slate-400 dark:text-slate-500 z-10">
                                        <i class="fas fa-camera text-2xl mb-1"></i>
                                        <span class="text-sm block">Change Photo</span>
                                    </div>
                                </label>
                                <div class="flex-1 w-full">
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Full Name</label>
                                        <input type="text" id="profile-name" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Email (Read-only)</label>
                                        <input type="email" id="profile-email" readonly class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-slate-50 outline-none dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 cursor-not-allowed">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-lg shadow-indigo-200 transition-all transform hover:scale-[1.02] dark:shadow-indigo-900/50">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 dark:bg-slate-900 dark:border-slate-700/50 anim-slide-fade-up anim-delay-3">
                        <h3 class="font-bold text-slate-800 mb-6 dark:text-slate-100 text-lg">Change Password</h3>
                        <form onsubmit="handleChangePassword(event)" class="space-y-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Old Password</label>
                                <input type="password" id="profile-old-pass" required class="w-full px-4 py-3 pr-10 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                                <i id="profile-toggle-old" class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('profile-old-pass', 'profile-toggle-old')"></i>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">New Password</label>
                                <input type="password" id="profile-new-pass" required class="w-full px-4 py-3 pr-10 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                                <i id="profile-toggle-new" class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('profile-new-pass', 'profile-toggle-new')"></i>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-medium text-slate-700 mb-1 dark:text-slate-300">Confirm New Password</label>
                                <input type="password" id="profile-confirm-pass" required class="w-full px-4 py-3 pr-10 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400">
                                <i id="profile-toggle-confirm" class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('profile-confirm-pass', 'profile-toggle-confirm')"></i>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg shadow-lg shadow-indigo-200 transition-all transform hover:scale-[1.02] dark:shadow-indigo-900/50">
                                    Update Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="transaction-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 opacity-0 dark:bg-black/70 dark:backdrop-blur-md">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform duration-300 dark:bg-slate-800" id="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="modal-title">Add Income</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 dark:text-slate-400 dark:hover:text-slate-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form onsubmit="handleTransactionSubmit(event)">
                <input type="hidden" id="transaction-type">
                <input type="hidden" id="t-edit-id"> 
                
                <div class="flex gap-3 mb-4">
                    <div class="w-1/4">
                        <label class="block text-xs font-medium text-slate-500 mb-1 dark:text-slate-300">Icon</label>
                        <select id="t-icon" class="w-full px-3 py-3 rounded-lg border border-slate-200 bg-white focus:ring-2 focus:ring-indigo-200 outline-none text-xl text-center dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            <option value="üí∞">üí∞</option>
                            <option value="üíµ">üíµ</option>
                            <option value="üçï">üçï</option>
                            <option value="üöó">üöó</option>
                            <option value="üè†">üè†</option>
                            <option value="üéÅ">üéÅ</option>
                            <option value="üéì">üéì</option>
                            <option value="üíä">üíä</option>
                            <option value="‚úàÔ∏è">‚úàÔ∏è</option>
                            <option value="üõí">üõí</option>
                            <option value="üí°">üí°</option>
                        </select>
                    </div>
                    <div class="w-3/4">
                        <label class="block text-xs font-medium text-slate-500 mb-1 dark:text-slate-300">Title</label>
                        <input type="text" id="t-title" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" placeholder="e.g. Salary">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-500 mb-1 dark:text-slate-300">Amount</label>
                    <input type="number" id="t-amount" required min="0" step="0.01" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400" placeholder="0.00">
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-500 mb-1 dark:text-slate-300">Date</label>
                    <input type="date" id="t-date" required class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-500 mb-1 dark:text-slate-300">Category</label>
                    <select id="t-category-income" class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <option value="Salary">Salary</option>
                        <option value="Freelance">Freelance</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Gift">Gift</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="t-category-expense" class="hidden w-full px-4 py-3 rounded-lg border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <option value="Food">Food</option>
                        <option value="Rent">Rent</option>
                        <option value="Transport">Transport</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Health">Health</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-medium text-slate-500 mb-1 dark:text-slate-300">Description (Optional)</label>
                    <textarea id="t-desc" rows="2" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none resize-none dark:bg-slate-700 dark:border-slate-600 dark:text-white dark:placeholder-slate-400"></textarea>
                </div>

                <button type="submit" id="modal-submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all dark:shadow-indigo-900/50">
                    Save Transaction
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- NEW: Toast Notification Function ---
        let toastTimeout;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            if (toastTimeout) {
                clearTimeout(toastTimeout);
            }

            toastMessage.innerText = message;
            
            // Reset classes
            toast.classList.remove('bg-emerald-500', 'text-white', 'bg-red-500', 'dark:bg-emerald-600', 'dark:bg-red-600', 'slideInRight', 'slideOutRight', 'hidden');
            toastIcon.classList.remove('fa-check-circle', 'fa-exclamation-triangle');

            if (type === 'success') {
                toast.classList.add('bg-emerald-500', 'text-white', 'dark:bg-emerald-600');
                toastIcon.classList.add('fa-check-circle');
            } else { // error
                toast.classList.add('bg-red-500', 'text-white', 'dark:bg-red-600');
                toastIcon.classList.add('fa-exclamation-triangle');
            }

            toast.classList.remove('hidden');
            toast.style.animation = 'slideInRight 0.5s ease-out forwards';

            toastTimeout = setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.5s ease-in forwards';
                setTimeout(() => toast.classList.add('hidden'), 500);
            }, 3000);
        }

        // --- NEW: Password Toggle Function ---
        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // --- Dark Mode Toggle Logic ---
        function setDarkMode(isDark) {
            const html = document.documentElement;
            const moonIcon = document.getElementById('moon-icon');
            const sunIcon = document.getElementById('sun-icon');
            const themeText = document.getElementById('theme-text');

            if (isDark) {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                if(moonIcon) moonIcon.classList.add('hidden');
                if(sunIcon) sunIcon.classList.remove('hidden');
                if(themeText) themeText.innerText = 'Light Mode';
            } else {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                if(moonIcon) moonIcon.classList.remove('hidden');
                if(sunIcon) sunIcon.classList.add('hidden');
                if(themeText) themeText.innerText = 'Dark Mode';
            }
            
            if (typeof updateUI === 'function' && state.user) {
                updateUI();
            }
        }

        function toggleDarkMode() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            setDarkMode(!isDarkMode);
        }

        // --- User Auth Storage Helpers ---
        function getUsersFromStorage() {
            const users = localStorage.getItem('expenseTrackerUsers');
            return users ? JSON.parse(users) : [];
        }

        function saveUsersToStorage(users) {
            localStorage.setItem('expenseTrackerUsers', JSON.stringify(users));
        }

        // --- Transaction storage ---
        function getSavedTransactions() {
            const userEmail = state.user.email;
            const storageKey = `expenseTrackerTransactions_${userEmail}`;
            const saved = localStorage.getItem(storageKey);
            
            if (saved) {
                return JSON.parse(saved);
            } else {
                return [
                    { id: 1, type: 'income', title: 'Salary', amount: 150000, date: '2023-10-01', icon: 'üí∞', desc: 'Monthly Salary', category: 'Salary' },
                    { id: 2, type: 'expense', title: 'Rent', amount: 12000, date: '2023-10-02', icon: 'üè†', desc: 'October Rent', category: 'Rent' },
                    { id: 3, type: 'income', title: 'Freelance', amount: 80000, date: '2023-10-05', icon: 'üíµ', desc: 'Website Project', category: 'Freelance' },
                    { id: 4, type: 'expense', title: 'Groceries', amount: 35000, date: '2023-10-06', icon: 'üçï', desc: 'Weekly shop', category: 'Food' },
                    { id: 5, type: 'expense', title: 'Car Fuel', amount: 5000, date: '2023-10-08', icon: 'üöó', desc: 'Gas for the month', category: 'Transport' },
                    { id: 6, type: 'expense', title: 'Electricity Bill', amount: 2500, date: '2023-10-10', icon: 'üí°', desc: '', category: 'Utilities' },
                    { id: 7, type: 'income', title: 'Birthday Gift', amount: 10000, date: '2023-10-12', icon: 'üéÅ', desc: 'From parents', category: 'Gift' },
                    { id: 8, type: 'expense', title: 'Movie Night', amount: 1500, date: '2023-10-14', icon: 'üçï', desc: 'Tickets and snacks', category: 'Entertainment' }
                ];
            }
        }

        function saveTransactionsToStorage() {
            const userEmail = state.user.email;
            const storageKey = `expenseTrackerTransactions_${userEmail}`;
            localStorage.setItem(storageKey, JSON.stringify(state.transactions));
        }

        // --- State Management ---
        let state = {
            transactions: [],
            user: null 
        };

        // Chart Instances
        let dashboardLineChart, dashboardDoughnutChart, incomeBarChart, expenseLineChart;

        // --- Auth Functions ---
        function toggleAuth(view) {
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            
            if(view === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        // MODIFIED: Generic Image Preview
        function previewImage(event, previewId, placeholderId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    if (placeholder) placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.classList.add('hidden');
                if (placeholder) placeholder.classList.remove('hidden');
            }
        }

        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const preview = document.getElementById('signup-preview');
            const photoDataUrl = preview.src; 

            const users = getUsersFromStorage();
            const existingUser = users.find(u => u.email === email);

            if (existingUser) {
                showToast('An account with this email already exists!', 'error');
            } else {
                const newUser = { name, email, password, photo: photoDataUrl };
                users.push(newUser);
                saveUsersToStorage(users);
                
                showToast('Signup successful! Please log in.', 'success');
                toggleAuth('login');
                e.target.reset();
                preview.src = '';
                preview.classList.add('hidden');
                document.getElementById('signup-placeholder').classList.remove('hidden');
            }
        }

        // NEW: Helper to update user info in UI
        function updateUserDisplayInfo() {
            if (!state.user) return;
            
            document.getElementById('user-name').innerText = state.user.name;
            document.getElementById('user-email').innerText = state.user.email;
            
            const placeholderImg = `https://placehold.co/100x100/6366f1/ffffff?text=${state.user.name.charAt(0).toUpperCase()}`;
            const userPhoto = (state.user.photo && state.user.photo.startsWith('data:image/')) 
                                ? state.user.photo 
                                : placeholderImg;
            
            document.getElementById('sidebar-user-photo').src = userPhoto;
            document.getElementById('header-user-photo').src = userPhoto;

            // Update profile page form fields
            const profileName = document.getElementById('profile-name');
            if (profileName) {
                profileName.value = state.user.name;
            }
            const profileEmail = document.getElementById('profile-email');
            if (profileEmail) {
                profileEmail.value = state.user.email;
            }
            const profilePreview = document.getElementById('profile-preview');
            const profilePlaceholder = document.getElementById('profile-placeholder');
            if (profilePreview) {
                profilePreview.src = userPhoto;
                profilePreview.classList.remove('hidden');
                if (profilePlaceholder) profilePlaceholder.classList.add('hidden');
            }
        }


        function initializeUserSession(user) {
            state.user = user; 
            state.transactions = getSavedTransactions();
            
            updateUserDisplayInfo(); // NEW: Centralized UI update

            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('flex');
            
            initApp();
            
            showToast('Login successful! Welcome back.', 'success');
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const users = getUsersFromStorage();
            const user = users.find(u => u.email === email);

            if (!user || user.password !== password) {
                showToast('Invalid email or password!', 'error');
                return;
            }

            localStorage.setItem('loggedInUserEmail', user.email);
            initializeUserSession(user);
        }

        function logout() {
            localStorage.removeItem('loggedInUserEmail');
            localStorage.removeItem('lastActiveView');

            state.user = null;
            state.transactions = []; 
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('flex');
            document.getElementById('auth-section').classList.remove('hidden');
            
            if(dashboardLineChart) dashboardLineChart.destroy();
            if(dashboardDoughnutChart) dashboardDoughnutChart.destroy();
            if(incomeBarChart) incomeBarChart.destroy();
            if(expenseLineChart) expenseLineChart.destroy();

            const placeholderImg = 'https://placehold.co/100x100/6366f1/ffffff?text=USER';
            document.getElementById('sidebar-user-photo').src = placeholderImg;
            document.getElementById('header-user-photo').src = placeholderImg;

            document.getElementById('signup-preview').src = '';
            document.getElementById('signup-preview').classList.add('hidden');
            document.getElementById('signup-placeholder').classList.remove('hidden');
            document.getElementById('signup-photo').value = null; 

            // NEW: Clear profile photo preview on logout
            const profilePreview = document.getElementById('profile-preview');
            const profilePlaceholder = document.getElementById('profile-placeholder');
            if (profilePreview) {
                profilePreview.src = '';
                profilePreview.classList.add('hidden');
                profilePlaceholder.classList.remove('hidden');
            }
            
            showToast('You have been logged out successfully.', 'success');
        }

        // --- Navigation ---
        function navigate(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-indigo-50', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
                el.classList.add('text-slate-600', 'hover:bg-slate-50', 'dark:text-slate-400', 'dark:hover:bg-slate-800', 'dark:hover:text-slate-100');
            });
            
            // MODIFIED: Highlight logic for profile
            if (viewId === 'profile') {
                document.getElementById('nav-profile-block').classList.add('bg-indigo-50', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
                document.getElementById('nav-profile').classList.add('bg-indigo-50', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
            } else {
                const activeNav = document.getElementById(`nav-${viewId}`);
                if(activeNav) {
                    activeNav.classList.add('bg-indigo-50', 'text-indigo-600', 'dark:bg-indigo-900/50', 'dark:text-indigo-300');
                }
            }

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('animate-fade-in');
            });
            
            const viewToShow = document.getElementById(`view-${viewId}`);
            viewToShow.classList.remove('hidden');
            
            requestAnimationFrame(() => {
                viewToShow.classList.add('animate-fade-in');
            });

            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('mobile-overlay').classList.add('hidden');
            }

            localStorage.setItem('lastActiveView', viewId);
            
            // MODIFIED: Call updateUserDisplayInfo when navigating to profile
            if (viewId === 'profile') {
                updateUserDisplayInfo();
            }

            // MODIFIED: Only run updateUI for relevant views
            if (['dashboard', 'income', 'expenses'].includes(viewId)) {
                updateUI();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // --- Modal Functions ---
        function openModal(type) {
            const modal = document.getElementById('transaction-modal');
            const modalContent = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            const typeInput = document.getElementById('transaction-type');
            const submitButton = document.getElementById('modal-submit-button');
            
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            });

            document.getElementById('t-edit-id').value = '';
            submitButton.innerText = 'Save Transaction';

            if (type === 'income') {
                title.innerText = 'Add Income';
                document.getElementById('t-category-income').classList.remove('hidden');
                document.getElementById('t-category-expense').classList.add('hidden');
            } else {
                title.innerText = 'Add Expense';
                document.getElementById('t-category-income').classList.add('hidden');
                document.getElementById('t-category-expense').classList.remove('hidden');
            }
            
            typeInput.value = type;
            
            document.getElementById('t-title').value = '';
            document.getElementById('t-amount').value = '';
            document.getElementById('t-date').valueAsDate = new Date();
            document.getElementById('t-desc').value = '';
            document.getElementById('t-icon').value = 'üí∞'; 
        }

        function openModalForEdit(transactionId) {
            const transaction = state.transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            openModal(transaction.type);

            document.getElementById('t-edit-id').value = transaction.id;
            document.getElementById('modal-title').innerText = `Edit ${transaction.type === 'income' ? 'Income' : 'Expense'}`;
            document.getElementById('modal-submit-button').innerText = 'Update Transaction';

            document.getElementById('t-title').value = transaction.title;
            document.getElementById('t-amount').value = transaction.amount;
            document.getElementById('t-date').value = transaction.date;
            document.getElementById('t-icon').value = transaction.icon;
            document.getElementById('t-desc').value = transaction.desc;

            if (transaction.type === 'income') {
                document.getElementById('t-category-income').value = transaction.category;
            } else {
                document.getElementById('t-category-expense').value = transaction.category;
            }
        }

        function closeModal() {
            const modal = document.getElementById('transaction-modal');
            const modalContent = document.getElementById('modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('t-edit-id').value = '';
                document.getElementById('modal-title').innerText = 'Add Transaction';
                document.getElementById('modal-submit-button').innerText = 'Save Transaction';
            }, 300);
        }

        // --- NEW: Profile Update Functions (from 1.html) ---
        function handleUpdateProfile(e) {
            e.preventDefault();
            const newName = document.getElementById('profile-name').value;
            const newPhoto = document.getElementById('profile-preview').src;

            // Find user in storage and update
            let users = getUsersFromStorage();
            let userIndex = users.findIndex(u => u.email === state.user.email);
            
            if (userIndex !== -1) {
                users[userIndex].name = newName;
                users[userIndex].photo = newPhoto;
                saveUsersToStorage(users);

                // Update state
                state.user.name = newName;
                state.user.photo = newPhoto;

                // Update UI
                updateUserDisplayInfo();
                showToast('Profile updated successfully!', 'success');
            } else {
                showToast('Error updating profile. User not found.', 'error');
            }
        }

        function handleChangePassword(e) {
            e.preventDefault();
            const oldPass = document.getElementById('profile-old-pass').value;
            const newPass = document.getElementById('profile-new-pass').value;
            const confirmPass = document.getElementById('profile-confirm-pass').value;

            if (newPass !== confirmPass) {
                showToast('New passwords do not match!', 'error');
                return;
            }

            if (oldPass !== state.user.password) {
                showToast('Incorrect old password!', 'error');
                return;
            }

            if (!newPass) {
                showToast('New password cannot be empty.', 'error');
                return;
            }

            // Find user in storage and update
            let users = getUsersFromStorage();
            let userIndex = users.findIndex(u => u.email === state.user.email);

            if (userIndex !== -1) {
                users[userIndex].password = newPass;
                saveUsersToStorage(users);
                state.user.password = newPass;

                showToast('Password changed successfully!', 'success');
                e.target.reset();
            } else {
                showToast('Error changing password. User not found.', 'error');
            }
        }
        // --- End Profile Functions ---

        function handleTransactionSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('t-edit-id').value;

            const transactionData = {
                type: document.getElementById('transaction-type').value,
                title: document.getElementById('t-title').value,
                amount: parseFloat(document.getElementById('t-amount').value),
                date: document.getElementById('t-date').value,
                icon: document.getElementById('t-icon').value,
                desc: document.getElementById('t-desc').value,
                category: (document.getElementById('transaction-type').value === 'income')
                    ? document.getElementById('t-category-income').value
                    : document.getElementById('t-category-expense').value
            };

            if (editId) {
                const transactionIndex = state.transactions.findIndex(t => t.id === parseInt(editId));
                if (transactionIndex > -1) {
                    state.transactions[transactionIndex] = { ...state.transactions[transactionIndex], ...transactionData };
                }
            } else {
                const newTransaction = {
                    id: Date.now(),
                    ...transactionData
                };
                state.transactions.push(newTransaction);
            }

            saveTransactionsToStorage(); 
            updateUI();
            closeModal();
            
            showToast(editId ? 'Transaction updated successfully!' : 'Transaction added successfully!', 'success');
        }

        function deleteTransaction(id) {
            if(confirm('Are you sure you want to delete this record?')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                saveTransactionsToStorage();
                updateUI();
                showToast('Transaction deleted successfully.', 'success');
            }
        }

        function populateCategoryFilter(selectId, categories) {
            const select = document.getElementById(selectId);
            if (!select) return; 
            
            const currentValue = select.value;
            const existingOptions = Array.from(select.options).slice(1).map(opt => opt.value);
            const newCategories = categories.filter(cat => cat && !existingOptions.includes(cat));
            
            newCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.text = cat;
                select.appendChild(option);
            });
            
            select.value = categories.includes(currentValue) ? currentValue : 'all';
        }


        // --- UI Update Logic ---
        function initApp() {
            const lastView = localStorage.getItem('lastActiveView');
            navigate(lastView || 'dashboard');
        }

        function updateUI() {
            if (!state.user) return; 

            const incomes = state.transactions.filter(t => t.type === 'income');
            const expenses = state.transactions.filter(t => t.type === 'expense');
            
            const totalIncome = incomes.reduce((acc, curr) => acc + curr.amount, 0);
            const totalExpense = expenses.reduce((acc, curr) => acc + curr.amount, 0);
            const totalBalance = totalIncome - totalExpense;

            if (document.getElementById('total-balance')) {
                document.getElementById('total-balance').innerText = `‚Çπ${totalBalance.toLocaleString('en-IN')}`;
                document.getElementById('total-income').innerText = `‚Çπ${totalIncome.toLocaleString('en-IN')}`;
                document.getElementById('total-expense').innerText = `‚Çπ${totalExpense.toLocaleString('en-IN')}`;

                const maxInc = incomes.length > 0 ? Math.max(...incomes.map(t => t.amount)) : 0;
                const maxExp = expenses.length > 0 ? Math.max(...expenses.map(t => t.amount)) : 0;
                document.getElementById('max-income-val').innerText = `‚Çπ${maxInc.toLocaleString('en-IN')}`;
                document.getElementById('max-expense-val').innerText = `‚Çπ${maxExp.toLocaleString('en-IN')}`;
            }

            const incomeCategories = [...new Set(incomes.map(t => t.category))].filter(Boolean);
            const expenseCategories = [...new Set(expenses.map(t => t.category))].filter(Boolean);
            populateCategoryFilter('income-filter', incomeCategories);
            populateCategoryFilter('expense-filter', expenseCategories);

            const incomeSort = document.getElementById('income-sort')?.value;
            const incomeFilter = document.getElementById('income-filter')?.value;
            const expenseSort = document.getElementById('expense-sort')?.value;
            const expenseFilter = document.getElementById('expense-filter')?.value;

            let filteredIncomes = (incomeFilter === 'all' || !incomeFilter)
                ? incomes
                : incomes.filter(t => t.category === incomeFilter);
            
            let filteredExpenses = (expenseFilter === 'all' || !expenseFilter)
                ? expenses
                : expenses.filter(t => t.category === expenseFilter);

            const sortFunctions = {
                'date-desc': (a, b) => new Date(b.date) - new Date(a.date),
                'date-asc': (a, b) => new Date(a.date) - new Date(b.date),
                'amount-desc': (a, b) => b.amount - a.amount,
                'amount-asc': (a, b) => a.amount - b.amount
            };
            
            if (incomeSort && sortFunctions[incomeSort]) {
                filteredIncomes.sort(sortFunctions[incomeSort]);
            }
            if (expenseSort && sortFunctions[expenseSort]) {
                filteredExpenses.sort(sortFunctions[expenseSort]);
            }

            renderList('income-list', filteredIncomes);
            renderList('expense-list', filteredExpenses);
            renderRecentList(); 

            renderCharts(incomes, expenses, totalIncome, totalExpense); 
        }

        function renderList(elementId, items) {
            const container = document.getElementById(elementId);
            if (!container) return; 
            
            if (items.length === 0) {
                 container.innerHTML = '<p class="text-sm text-slate-400 text-center py-4 dark:text-slate-500">No transactions for this view.</p>';
                 return;
            }
            
            container.innerHTML = items.map((item, index) => `
                <div class="bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center hover:shadow-md transition-shadow group dark:bg-slate-900 dark:border-slate-700/50 dark:hover:bg-slate-800/50 anim-slide-fade-up"
                     style="animation-delay: ${index * 50}ms; animation-fill-mode: backwards;">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full ${item.type === 'income' ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-400' : 'bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-400'} flex items-center justify-center text-2xl">
                            ${item.icon}
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-100">${item.title}</h4>
                            <div class="text-xs text-slate-400 flex flex-wrap gap-x-2 dark:text-slate-500">
                                <span><i class="far fa-calendar-alt"></i> ${item.date}</span>
                                ${item.category ? `<span>‚Ä¢ ${item.category}</span>` : ''}
                            </div>
                            ${item.desc ? `<p class="text-xs text-slate-500 mt-1 dark:text-slate-400">${item.desc}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold ${item.type === 'income' ? 'text-emerald-500 dark:text-emerald-400' : 'text-red-500 dark:text-red-400'}">
                            ${item.type === 'income' ? '+' : '-'}&#8377;${item.amount.toLocaleString('en-IN')}
                        </span>
                        
                        <button onclick="openModalForEdit(${item.id})" class="text-slate-300 hover:text-indigo-500 transition-colors opacity-0 group-hover:opacity-100 dark:text-slate-600 dark:hover:text-indigo-500">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button onclick="deleteTransaction(${item.id})" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 dark:text-slate-600 dark:hover:text-red-500">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentList() {
            const container = document.getElementById('recent-transactions-list');
            if (!container) return; 

            const recent = [...state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-400 text-center py-4 dark:text-slate-500">No transactions yet.</p>';
                return;
            }

            container.innerHTML = recent.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg dark:bg-slate-800/60 anim-fade"
                     style="animation-delay: ${index * 75}ms; animation-fill-mode: backwards;">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${item.icon}</span>
                        <span class="font-medium text-slate-700 text-sm dark:text-slate-200">${item.title}</span>
                    </div>
                    <span class="font-bold text-sm ${item.type === 'income' ? 'text-emerald-500 dark:text-emerald-400' : 'text-red-500 dark:text-red-400'}">
                         ${item.type === 'income' ? '+' : '-'}&#8377;${item.amount.toLocaleString('en-IN')}
                    </span>
                </div>
            `).join('');
        }

        function renderCharts(incomes, expenses, totalInc, totalExp) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? '#334155' : '#e2e8f0'; 
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b'; 
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            
            const labels = [...new Set(state.transactions.map(t => t.date))].sort();
            
            if(dashboardLineChart) dashboardLineChart.destroy();
            if(dashboardDoughnutChart) dashboardDoughnutChart.destroy();
            if(incomeBarChart) incomeBarChart.destroy();
            if(expenseLineChart) expenseLineChart.destroy();

            // 1. Dashboard Line Chart
            const ctx1 = document.getElementById('dashboardLineChart');
            if (ctx1) { 
                dashboardLineChart = new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: labels.map(d => incomes.filter(t => t.date === d).reduce((a,c)=>a+c.amount,0)),
                                borderColor: '#10b981',
                                backgroundColor: isDarkMode ? 'rgba(16, 185, 129, 0.3)' : 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Expense',
                                data: labels.map(d => expenses.filter(t => t.date === d).reduce((a,c)=>a+c.amount,0)),
                                borderColor: '#ef4444',
                                backgroundColor: isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.parsed.y;
                                        let label = `Total ${context.dataset.label}: ‚Çπ${total.toLocaleString('en-IN')}`;
                                        return label;
                                    },
                                    afterBody: function(context) {
                                        const tooltipItem = context[0];
                                        const date = tooltipItem.label; 
                                        const datasetIndex = tooltipItem.datasetIndex;
                                        const type = (datasetIndex === 0) ? 'income' : 'expense';
                                        const transactionsOnThisDay = state.transactions
                                            .filter(t => t.date === date && t.type === type);
                                        
                                        if (transactionsOnThisDay.length > 0) {
                                            return transactionsOnThisDay.map(t => `  ‚Ä¢ ${t.title}: ‚Çπ${t.amount.toLocaleString('en-IN')}`);
                                        }
                                        return [];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: gridColor } },
                            y: { grid: { color: gridColor } }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart',
                            delay: 500 
                        }
                    }
                });
            }

            // 2. Dashboard Doughnut
            const ctx2 = document.getElementById('dashboardDoughnutChart');
            if (ctx2) { 
                const incomeColor = isDarkMode ? '#10b981' : '#34d399';
                const expenseColor = isDarkMode ? '#ef4444' : '#f87171';
                const originalColors = [incomeColor, expenseColor];
                const dimmedColors = [incomeColor + '80', expenseColor + '80'];

                dashboardDoughnutChart = new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Income', 'Expense'],
                        datasets: [{
                            data: [totalInc, totalExp],
                            backgroundColor: originalColors,
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        hoverOffset: 20,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        onHover: (event, chartElement) => {
                            const chart = event.chart;
                            if (chartElement.length > 0) {
                                chart.data.datasets[0].backgroundColor = [...dimmedColors];
                                chart.data.datasets[0].backgroundColor[chartElement[0].index] = originalColors[chartElement[0].index];
                            } else {
                                chart.data.datasets[0].backgroundColor = [...originalColors];
                            }
                            chart.update('none');
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeOutQuart',
                            animateRotate: true,
                            animateScale: true,
                            delay: 700
                        }
                    }
                });
            }

            // 3. Income Bar Chart
            const ctx3 = document.getElementById('incomeBarChart');
            if (ctx3) { 
                incomeBarChart = new Chart(ctx3.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Earnings',
                            data: labels.map(d => incomes.filter(t => t.date === d).reduce((a,c)=>a+c.amount,0)),
                            backgroundColor: isDarkMode ? '#10b981' : '#34d399',
                            borderRadius: 5
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { color: gridColor } }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutBack',
                            delay: 300
                        }
                    }
                });
            }

            // 4. Expense Line Chart
            const ctx4 = document.getElementById('expenseLineChart');
            if (ctx4) { 
                expenseLineChart = new Chart(ctx4.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spending',
                            data: labels.map(d => expenses.filter(t => t.date === d).reduce((a,c)=>a+c.amount,0)),
                            borderColor: isDarkMode ? '#ef4444' : '#f87171',
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: gridColor } },
                            y: { grid: { color: gridColor } }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart',
                            delay: 300
                        }
                    }
                });
            }
        }

        // --- Session Persistence ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                setDarkMode(true);
            } else {
                setDarkMode(false);
            }

            document.getElementById('income-sort')?.addEventListener('change', updateUI);
            document.getElementById('income-filter')?.addEventListener('change', updateUI);
            document.getElementById('expense-sort')?.addEventListener('change', updateUI);
            document.getElementById('expense-filter')?.addEventListener('change', updateUI);

            const loggedInEmail = localStorage.getItem('loggedInUserEmail');
            if (loggedInEmail) {
                const users = getUsersFromStorage();
                const user = users.find(u => u.email === loggedInEmail);

                if (user) {
                    initializeUserSession(user);
                } else {
                    localStorage.removeItem('loggedInUserEmail');
                    document.getElementById('auth-section').classList.remove('hidden');
                }
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>